<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Админка - Добавить участок</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 40px auto; background: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.07); }
        h1 { text-align: center; margin-bottom: 24px; }
        label { font-weight: bold; display: block; margin-top: 20px; }
        input[type="text"], textarea, select {
            width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box;
        }
        textarea { resize: vertical; }
        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }
        .checkbox-group { margin-top: 8px; }
        .checkbox-group label { font-weight: normal; display: inline-block; margin-right: 18px; }
        button { margin-top: 24px; width: 100%; padding: 12px; background: #2b7cff; color: #fff; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; }
        button:hover { background: #1a5fd6; }
        #preview { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        #preview img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; }
        #result { margin-top: 20px; color: green; text-align:center; }
        .cards-list { margin-top: 40px; }
        .admin-card {
            background: #f4f4f4; border-radius: 8px; padding: 15px 12px; margin-bottom: 16px; display: flex; flex-direction: column; gap: 7px;
        }
        .admin-card .images-preview {
            display: flex;
            gap: 7px;
            overflow-x: auto;
            max-width: 100%;
            padding-bottom: 6px;
        }
        .admin-card img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ccc;
            flex: 0 0 auto;
        }
        .admin-card .actions { margin-top: 9px; display: flex; gap: 8px; }
        .admin-card .actions button {
            width: auto;
            padding: 8px 16px;
            font-size: 1em;
            margin: 0;
            background: #d32f2f;
        }
        .admin-card .actions button.edit-btn { background: #2b7cff; }
        .admin-card .actions button:hover { opacity: 0.88; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Добавить участок</h1>
        <form id="adminForm">
            <!-- Скрытый input для id (для редактирования) -->
            <input type="hidden" id="itemId" name="id">
            <label for="photo">Фото (любое количество)</label>
            <input type="file" id="photo" name="photo" accept="image/*" multiple>
            <div id="preview"></div>
            <label for="address">Адрес</label>
            <input type="text" id="address" name="address" placeholder="Введите адрес">
            <label for="description">Описание</label>
            <textarea id="description" name="description" rows="3" placeholder="Краткое описание"></textarea>
            <div class="row">
                <div>
                    <label for="area_house">м² строения</label>
                    <input type="text" id="area_house" name="area_house" placeholder="Площадь дома">
                </div>
                <div>
                    <label for="area_land">Площадь участка (м²)</label>
                    <input type="text" id="area_land" name="area_land" placeholder="Площадь участка">
                </div>
            </div>
            <label for="land_category">Категория земли</label>
            <input type="text" id="land_category" name="land_category" placeholder="Категория земли">
            <label for="status">Статус участка</label>
            <input type="text" id="status" name="status" placeholder="Статус (например, продается)">
            <label for="material">Материал дома</label>
            <input type="text" id="material" name="material" placeholder="Материал (кирпич, дерево и т.д.)">
            <label for="condition">Состояние ремонта</label>
            <input type="text" id="condition" name="condition" placeholder="Состояние ремонта">
            <label>Блок. Коммуникации:</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="utilities" value="Электричество"> Электричество</label>
                <label><input type="checkbox" name="utilities" value="Газ"> Газ</label>
                <label><input type="checkbox" name="utilities" value="Канализация"> Канализация</label>
                <label><input type="checkbox" name="utilities" value="Водоснабжение"> Водоснабжение</label>
            </div>
            <label for="village">Наименование поселка</label>
            <input type="text" id="village" name="village" placeholder="Название поселка">
            <label for="price">Цена (₽)</label>
            <input type="text" id="price" name="price" placeholder="Введите цену">
            <button type="submit" id="submitBtn">Сохранить</button>
        </form>
        <div id="result"></div>

        <div class="cards-list" id="cardsList"></div>
    </div>
    <script>
        // Preview images
        document.getElementById('photo').addEventListener('change', function(event) {
            const files = event.target.files;
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(files[i]);
            }
        });

        // --- CRUD ФУНКЦИИ ---

        // Получение всех карточек
        function fetchCards() {
            fetch('/api/list')
                .then(r => r.json())
                .then(showCards)
                .catch(() => {
                    document.getElementById('cardsList').innerHTML = 'Ошибка загрузки карточек!';
                });
        }

        // Показать карточки
        function showCards(cards) {
            const list = document.getElementById('cardsList');
            list.innerHTML = '';
            if (!cards.length) {
                list.innerHTML = '<div style="color:#888;text-align:center;">Нет объектов</div>';
                return;
            }
            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = 'admin-card';
                el.innerHTML = `
                    <div><b>${card.village || ''}</b> ${card.address ? ' — ' + card.address : ''}</div>
                    <div>Площадь: ${card.area_house || '—'} м², Участок: ${card.area_land || '—'} м²</div>
                    <div>Цена: ${card.price ? card.price.replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " ₽" : '—'}</div>
                    <div class="images-preview">
                        ${(card.images || []).map(url => `<img src="${url}" alt="">`).join('')}
                    </div>
                    <div class="actions">
                        <button class="edit-btn" data-id="${card.id}">Изменить</button>
                        <button data-id="${card.id}">Удалить</button>
                    </div>
                `;
                // Кнопка удалить
                el.querySelector('button:not(.edit-btn)').onclick = function() {
                    if (confirm('Удалить объект?')) {
                        fetch('/api/delete', {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ id: card.id })
                        })
                        .then(r => r.json())
                        .then(res => {
                            fetchCards();
                        });
                    }
                };
                // Кнопка изменить
                el.querySelector('.edit-btn').onclick = function() {
                    fillForm(card);
                    window.scrollTo({top: 0, behavior: 'smooth'});
                };
                list.appendChild(el);
            });
        }

        // Заполнить форму для редактирования
        function fillForm(card) {
            // Заполняем значения
            document.getElementById('itemId').value = card.id || '';
            document.getElementById('address').value = card.address || '';
            document.getElementById('description').value = card.description || '';
            document.getElementById('area_house').value = card.area_house || '';
            document.getElementById('area_land').value = card.area_land || '';
            document.getElementById('land_category').value = card.land_category || '';
            document.getElementById('status').value = card.status || '';
            document.getElementById('material').value = card.material || '';
            document.getElementById('condition').value = card.condition || '';
            document.getElementById('village').value = card.village || '';
            document.getElementById('price').value = card.price || '';

            // Чекбоксы
            document.querySelectorAll('input[name="utilities"]').forEach(cb => {
                cb.checked = (card.utilities || []).includes(cb.value);
            });

            // Фото: нельзя редактировать, только при загрузке новых через input
            document.getElementById('preview').innerHTML = (card.images || []).map(url => `<img src="${url}" alt="">`).join('');
        }

        // --- Обработка формы ---
        document.getElementById('adminForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const form = event.target;
            const files = form.photo.files;
            const id = form.id.value;

            // Режим: если id есть, то это UPDATE, иначе CREATE
            const isEdit = !!id;

            // --- Для создания и для изменения логика разная ---
            function sendMainData(imagesArr) {
                const utilities = [];
                form.querySelectorAll('input[name="utilities"]:checked').forEach(ch => utilities.push(ch.value));
                const data = {
                    id: id || undefined,
                    images: imagesArr,
                    address: form.address.value,
                    description: form.description.value,
                    area_house: form.area_house.value,
                    area_land: form.area_land.value,
                    land_category: form.land_category.value,
                    status: form.status.value,
                    material: form.material.value,
                    condition: form.condition.value,
                    utilities,
                    village: form.village.value,
                    price: form.price.value
                };
                fetch(isEdit ? '/api/update' : '/api/add', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(data)
                })
                .then(r=>r.json())
                .then(res=>{
                    document.getElementById('result').textContent = 'Данные сохранены!';
                    form.reset();
                    document.getElementById('itemId').value = '';
                    document.getElementById('preview').innerHTML = '';
                    setTimeout(()=>{document.getElementById('result').textContent=''}, 1800);
                    fetchCards();
                })
                .catch(()=>{document.getElementById('result').textContent = 'Ошибка сохранения';});
            }

            // Если выбраны новые файлы — загружаем их
            if (files && files.length) {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('images', files[i]); // ИМЯ ПОЛЯ ДОЛЖНО БЫТЬ 'images'!
                }
                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(res => {
                    if (!res.uploaded) { // Ожидаем поле 'uploaded' из backend!
                        document.getElementById('result').textContent = 'Ошибка загрузки фото!';
                        return;
                    }
                    sendMainData(res.uploaded);
                })
                .catch(() => {
                    document.getElementById('result').textContent = 'Ошибка загрузки фото!';
                });

            } else {
                // Если редактируем — берём предыдущие фото (из превью)
                const imgs = Array.from(document.getElementById('preview').querySelectorAll('img')).map(img => img.src);
                if (!imgs.length && !isEdit) {
                    alert('Пожалуйста, загрузите хотя бы одну фотографию.');
                    return;
                }
                sendMainData(imgs);
            }
        });

        // Старт — подгрузить карточки
        fetchCards();
    </script>
</body>
</html>
